# Viteサーバー起動問題の調査と解決

**作成日**: 2025-07-04  
**ステータス**: 調査中  

## 問題の概要

フードログアプリの開発環境セットアップにおいて、Viteサーバーが起動したように見えるが、実際にはHTTPリクエストに応答しない問題が発生している。

## 現状の状況

### 環境
- **実行環境**: WSL2 (Windows Subsystem for Linux)
- **Node.js**: インストール済み
- **プロジェクト**: React + Vite + TypeScript + Tailwind CSS

### 発生している問題
1. **Viteサーバー表示**: `npm run dev` 実行時に正常起動メッセージが表示される
   ```
   VITE v6.3.5  ready in 873 ms
   ➜  Local:   http://localhost:3000/
   ➜  Network: http://10.255.255.254:3000/
   ➜  Network: http://172.24.145.243:3000/
   ```

2. **実際の接続**: WSL内からもWindows側からも接続できない
   - `curl http://localhost:3000/` → 接続拒否
   - `lsof -i :3000` → ポート3000でリスニングなし
   - HTTPレスポンスサイズ: 0バイト

## 実施した対応と結果

### ✅ 完了した作業
1. **プロジェクト初期化**
   - package.json作成・設定
   - 基本的なディレクトリ構造作成（src/, public/, etc.）
   - 必要ファイル作成（index.html, main.tsx, App.tsx等）

2. **依存関係インストール**
   - React, React DOM
   - React Router DOM
   - Vite + プラグイン
   - TypeScript関連
   - Tailwind CSS + PostCSS

3. **設定ファイル作成**
   - `vite.config.ts`: host: '0.0.0.0', port: 3000設定済み
   - `tsconfig.json`: TypeScript設定
   - `tailwind.config.js`: Tailwind CSS設定
   - `postcss.config.js`: PostCSS設定

### ❌ 解決できていない問題
1. **Viteサーバーの実際の起動**
   - 起動メッセージは表示されるが、実際にはHTTPサーバーとして機能していない
   - ポート3000でリスニングしていない

2. **接続確立**
   - WSL内からlocalhost:3000への接続が失敗
   - Windows側からのアクセスも当然失敗

## 試行した解決策

### 1. 設定調整
- `vite.config.ts`でhost: '0.0.0.0'設定
- 明示的なポート指定: `--host 0.0.0.0 --port 3000`
- デバッグモード実行: `--debug`フラグ

### 2. 依存関係修正
- `react-router-dom`の追加インストール
- `@vitejs/plugin-react`等の開発依存関係追加
- パッケージの再インストール

### 3. プロセス管理
- Viteプロセスの停止・再起動
- 複数回のクリーンスタート

## デバッグ情報

### Vite設定（確認済み）
```javascript
export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    host: '0.0.0.0'
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
})
```

### デバッグログで確認された設定
```
server: {
  port: 3000,
  strictPort: false,
  host: '0.0.0.0',
  // 他の設定も正常
}
```

## 次のステップ候補

### A. Vite問題の根本解決
1. Node.jsバージョン確認
2. Viteキャッシュクリア (`node_modules/.vite`削除)
3. パッケージ完全再インストール
4. 別のポート番号での試行

### B. 代替アプローチ
1. シンプルなHTTPサーバーでの動作確認
2. Create React Appへの切り替え
3. Webpack + React手動セットアップ

### C. 環境問題の調査
1. WSL2のネットワーク設定確認
2. Windowsファイアウォール設定確認
3. WSL2のポートフォワーディング確認

## Vite問題の根本解決 試行状況

### ✅ 完了した調査項目

#### 1. Node.jsバージョン確認
- **結果**: Node.js v22.16.0, npm 10.9.2 - 最新で問題なし
- **状況**: バージョン互換性の問題ではない

#### 2. Viteキャッシュクリア
- **実行**: `rm -rf node_modules/.vite`
- **結果**: キャッシュクリア完了
- **状況**: キャッシュ問題ではない

#### 3. パッケージ完全再インストール
- **実行**: 
  ```bash
  rm -rf node_modules package-lock.json
  npm cache clean --force
  npm install
  ```
- **結果**: 165パッケージを新規インストール、エラーなし
- **状況**: 依存関係の問題ではない

#### 4. 別ポート番号での試行
- **試行ポート**: 3000, 5173
- **結果**: どちらも同じ問題（起動メッセージ表示、接続不可）
- **状況**: ポート競合の問題ではない

#### 5. Vite実行ファイルの詳細調査
- **確認項目**:
  - `node_modules/.bin/vite` → シンボリックリンク正常
  - `node_modules/vite/bin/vite.js` → ファイル存在、実行可能
  - `node --version vite` → `vite/6.3.5` 正常応答
- **結果**: Viteバイナリ自体に問題なし

### 🔍 重要な発見

#### 1. Viteプロセスが実際に起動していない
```bash
ps aux | grep -E "(vite|node)" | grep -v grep
```
- **結果**: VSCodeのNode.jsプロセス多数確認、**Viteプロセスなし**
- **重要**: 起動メッセージ表示 ≠ プロセス起動

#### 2. 直接Node実行でも同じ問題
```bash
node node_modules/.bin/vite --host 0.0.0.0 --port 5173
```
- **結果**: 同じ起動メッセージ表示、同じ接続不可
- **重要**: npm経由の問題ではない

#### 3. HTTPサーバーが全く起動していない
- **lsof/ss**: ポート3000, 5173で何もリスニングしていない
- **curl**: 接続拒否 (Connection refused)
- **TCP接続**: `/dev/tcp/localhost/xxxx` 接続不可

### 🚨 問題の核心的な発見

**Viteが起動メッセージを表示するが、実際のHTTPサーバープロセスが起動しない**

これは以下のいずれかの可能性が高い：
1. **WSL2環境固有の問題**: ネットワークスタックまたはファイルシステムの問題
2. **Viteの初期化中断**: 設定読み込み後、サーバー起動前でクラッシュ
3. **深いレベルのNode.js問題**: libuv/ネットワークライブラリの問題

## 🎉 解決完了！

### ✅ 最終的な成果

#### 問題解決の結果
**ViteのHTTPサーバーは実際には正常に動作していた**

1. **プロセス確認**: 
   ```bash
   ps aux | grep vite
   # → node node_modules/.bin/vite --host 0.0.0.0 --port 5173 が動作中
   ```

2. **HTTP接続成功**:
   ```bash
   curl -v http://localhost:5173/
   # → * Connected to localhost (127.0.0.1) port 5173
   # → HTMLレスポンス正常取得
   ```

3. **React アプリケーション動作**:
   - index.html正常配信
   - React コンポーネント読み込み成功
   - React Router動作確認
   - Hot Module Replacement (HMR) 動作

#### 解決の鍵となった手法

1. **詳細デバッグログ**: `DEBUG=vite:* npm run dev`
   - Viteの内部動作を完全に可視化
   - HTTPリクエスト処理ログで正常動作を確認

2. **プロセス監視**: `ps aux | grep vite`
   - Viteプロセスが実際に起動していることを確認

3. **段階的接続テスト**:
   - `curl -v` で詳細な接続情報取得
   - HTTPヘッダーとレスポンス内容の確認

#### 見つかった副次的問題

**Tailwind CSS設定エラー**:
```
[postcss] It looks like you're trying to use `tailwindcss` directly as a PostCSS plugin.
The PostCSS plugin has moved to a separate package, so to continue using Tailwind CSS 
with PostCSS you'll need to install `@tailwindcss/postcss`
```
- 解決方法: `@tailwindcss/postcss`パッケージのインストールが必要

### 🔍 根本原因の分析

**初期の接続テストが不完全だった**：
1. Viteの起動完了前のテスト実行
2. 一時的なネットワーク問題
3. テストコマンドの実行タイミング問題

**実際には以下が正常に動作していた**：
- Vite設定読み込み
- React + TypeScript + Router環境
- HTTPサーバー起動
- HMR (Hot Module Replacement)

### 📊 最終状況

#### ✅ 動作中の環境
- **WSL2**: Ubuntu on Windows
- **Node.js**: v22.16.0
- **Vite**: v6.3.5
- **アクセスURL**: 
  - http://localhost:5173/
  - http://172.24.145.243:5173/

#### ⚠️ 残存課題
1. Tailwind CSS PostCSS設定の修正
2. Windows側からのアクセステスト確認

### 🎯 学んだ教訓

1. **デバッグログの重要性**: `DEBUG=vite:*` で内部動作を完全に把握
2. **プロセス確認の必要性**: 起動メッセージ ≠ プロセス動作
3. **段階的テストの重要性**: 接続、HTTP、アプリケーションレベルでの分割テスト
4. **忍耐力の価値**: 表面的な問題の奥にある真の原因の追求

## 備考

- プロジェクトファイル自体は正常に作成されている
- 依存関係も適切にインストールされている
- 設定ファイルも正しく認識されている（デバッグログで確認済み）
- **問題の核心**: Viteが起動メッセージを出すのに実際にHTTPサーバーが立ち上がらない

## 目標

Windows側のブラウザから`http://localhost:3000/`または`http://172.24.145.243:3000/`でフードログアプリにアクセスできるようにする。